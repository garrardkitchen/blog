<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="In my current role as Head of Cloud Platform, I am leading the technical effort of migrating our entire on-premise real-estate to Azure. Part of this mission, is to upgrade the runtimes of our applications, regardless of their current placement; IIS Web apps, Windows Services and Docker Swarm containers. I say &ldquo;part of this mission&rdquo; as another aspect of this migration is to create a new foundation for our platform - AKS."><meta property="og:title" content="Github Actions Workflow Env Vars" />
<meta property="og:description" content="In my current role as Head of Cloud Platform, I am leading the technical effort of migrating our entire on-premise real-estate to Azure. Part of this mission, is to upgrade the runtimes of our applications, regardless of their current placement; IIS Web apps, Windows Services and Docker Swarm containers. I say &ldquo;part of this mission&rdquo; as another aspect of this migration is to create a new foundation for our platform - AKS." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://blog.garrardkitchen.com/posts/github-actions-workflow-env-vars/" />
<meta property="article:published_time" content="2022-01-08T15:13:52+00:00" />
<meta property="article:modified_time" content="2022-01-09T11:36:20+00:00" />
<title>Github Actions Workflow Env Vars | Blog</title>
<link rel="icon" href="/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/book.min.6df681b0bb21155cba49f6078e3559216772d8e03e780d240c73ea21817ed5e5.css" integrity="sha256-bfaBsLshFVy6SfYHjjVZIWdy2OA&#43;eA0kDHPqIYF&#43;1eU=">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css"
  integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
<script defer src="/en.search.min.7a69b4791c966d7a6421f1c8c2172f73779921d9b31df6bb7f8fb82acc7707db.js" integrity="sha256-emm0eRyWbXpkIfHIwhcvc3eZIdmzHfa7f4&#43;4Ksx3B9s="></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-162297404-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>

<body>
  <input type="checkbox" class="hidden" id="menu-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  <nav>
<h2 class="book-brand">
  <a href="/"><span>Blog</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>











  

  



  
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/posts/" class="">Blog</a>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="/posts/npm-issues-e401-cert_not_yet_valid/" class="">Npm E401 and CERT_NOT_YET_VALID</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/posts/github-actions-workflow-env-vars/" class="active">Github Actions Workflow Env Vars</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/posts/runtimes/" class="">Runtimes</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/posts/permission-denied-while-trying-to-connect-to-the-docker-daemon-socket/" class="">Permission Denied While Trying to Connect to the Docker Daemon Socket</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/posts/my-first-outing-with-dapr/" class="">My First Outing With Dapr</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/posts/how-to-use-kubernetes-configmap/" class="">How to Use Kubernetes Configmap</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/posts/nodejs-container-restart-policy/" class="">Nodejs Container Restart Policy</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/posts/apache-ignite-running-agent-with-dotnetcore-server-node/" class="">How to run the Apache Ignite Agent with an Ignite.NET Core Server Node</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/posts/terraform-get-values/" class="">Terraform Get Values</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/posts/digital-certificates/" class="">Digital Certificates</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/posts/jest-fs-readFileSync/" class="">Unit testing and mocking fs.ReadFileSync</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/posts/kubernetes-on-windows/" class="">Kubernetes on Windows</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/posts/modern-javascript/" class="">Modern-ish Javascript</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/posts/mentoring/" class="">How do I mentor?</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="/posts/principles/" class="">Good Engineering - Principles</a>
  

        </li>
      
    
  </ul>
  

        </li>
      
    
  </ul>
  











  
<ul>
  
  <li>
    <a href="https://github.com/garrardkitchen" target="_blank" rel="noopener">
        Github
      </a>
  </li>
  
  <li>
    <a href="https://blog.garrardkitchen.com/" target="_blank" rel="noopener">
        Blog
      </a>
  </li>
  
  <li>
    <a href="https://katas.garrardkitchen.com/" target="_blank" rel="noopener">
        Katas
      </a>
  </li>
  
  <li>
    <a href="https://www.garrardkitchen.com/" target="_blank" rel="noopener">
        Resume
      </a>
  </li>
  
</ul>






</nav>




  <script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Github Actions Workflow Env Vars</strong>

  <label for="toc-control">
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
  </label>
</div>


  
    <input type="checkbox" class="hidden" id="toc-control" />
    <aside class="hidden clearfix">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#github-workflows">Github workflows</a></li>
    <li><a href="#cicd">CICD</a></li>
  </ul>
</nav>


    </aside>
  
 
      </header>

      
      
<article class="markdown">
  <h1>
    <a href="/posts/github-actions-workflow-env-vars/">Github Actions Workflow Env Vars</a>
  </h1>
  <p>
  
  <i>January 8, 2022</i>&nbsp;
  

  
  - &nbsp;<i class="fas fa-clock"></i>&nbsp;4&nbsp;mins read time
  
  
  - &nbsp;<i class="fas fa-book"></i>&nbsp;690&nbsp;words
  

  
  -&nbsp;<i class="fas fa-user"></i>&nbsp;garrardkitchen
  
</p>







<div>
  
  <a href="/tags/github-actions-linux-windows-syntax-self-hosted-runner-environment-variables-workflow-cicd/">github actions, linux, windows, syntax, self-hosted runner, environment variables, workflow, cicd</a>
</div>


  <p><p>In my current role as Head of Cloud Platform, I am leading the technical effort of migrating our entire on-premise real-estate to Azure.  Part of this mission, is to upgrade the runtimes of our applications, regardless of their current placement; IIS Web apps, Windows Services and Docker Swarm containers.  I say &ldquo;part of this mission&rdquo; as another aspect of this migration is to create a new foundation for our platform - AKS.  I hope to cover more on this in later posts.</p>
<h1 id="github-workflows">Github workflows</h1>
<p>We are using Self-Hosted Runners to build and deploy our applications to AKS.  We have a Hub&amp;Spoke network architecture and our AKS clusters are private.  We have other backing services that are deliberately behind Azure Private Endpoints.  Our architecture enables us to deploy securely from our company network to our spoke VNETs that exist across our Azure Subscriptions.</p>
<p>We&rsquo;re targeting 2 guest operating systems with our containerization orchestration solution - AKS.  These are Linux (.NET Core workloads) and Windows (.NET Framework workloads).  We are having to upgrade our .NET Framework runtimes to 4.8 as this is the minimum requirement to running containers in Kubernetes in Azure.</p>
<p>There are subtle GitHub Actions Workflows expression differences when working with Powershell and bash.  Here in this post I concentrate on how you create and set env vars.</p>
<p>Is the snippet below, which is from our <code>deploy</code> GHA workflow, I use a workflow_dispatch to deploy either a feature branch or our main branch.  Feature branches are deployed to our Development Cluster and non-feature branches to our Production Cluster.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml">- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">SETUP MAIN BRANCH</span>
  <span style="color:#f92672">if</span>: <span style="color:#ae81ff">${{ github.ref == &#39;refs/heads/main&#39; || github.ref == &#39;refs/heads/master&#39; }}</span>
  <span style="color:#f92672">run</span>: <span style="color:#ae81ff">|    </span>
    <span style="color:#ae81ff">echo &#34;ENV=prod&#34; &gt;&gt; $GITHUB_ENV        </span>
    <span style="color:#ae81ff">echo &#34;TAG=1.0.${{github.run_number}}&#34; &gt;&gt; $GITHUB_ENV       </span>
    <span style="color:#ae81ff">echo &#34;PWD=$(pwd)&#34; &gt;&gt; $GITHUB_ENV        </span>

- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">SETUP FEATURE BRANCH</span>
  <span style="color:#f92672">if</span>: <span style="color:#ae81ff">${{ github.ref != &#39;refs/heads/main&#39; &amp;&amp; github.ref != &#39;refs/heads/master&#39; }}</span>
  <span style="color:#f92672">run</span>: |<span style="color:#e6db74">
</span><span style="color:#e6db74">    echo &#34;ENV=dev&#34; &gt;&gt; $GITHUB_ENV        
</span><span style="color:#e6db74">    echo &#34;TAG=${{ github.ref_name }}&#34; &gt;&gt; $GITHUB_ENV
</span><span style="color:#e6db74">    echo &#34;PWD=$(pwd)&#34; &gt;&gt; $GITHUB_ENV        </span>    
</code></pre></div><p>In the example above, we generate env vars that are used later in this workflow.  The above is running on one of our Linux Self-Hosted Runners so using bash script.</p>
<p>The above example will not update env vars when run on a Windows Self-Hosted Runner (PowerShell).</p>
<p>The equivalent when targeting windows is:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml">- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">SETUP MAIN BRANCH</span>
  <span style="color:#f92672">if</span>: <span style="color:#ae81ff">${{ github.ref == &#39;refs/heads/main&#39; || github.ref == &#39;refs/heads/master&#39; }}</span>
  <span style="color:#f92672">run</span>: <span style="color:#ae81ff">|        </span>
    <span style="color:#ae81ff">echo &#34;ENV=prod&#34; &gt;&gt; $env:GITHUB_ENV        </span>
    <span style="color:#ae81ff">echo &#34;TAG=1.0.${{github.run_number}}&#34; &gt;&gt; $env:GITHUB_ENV       </span>
    <span style="color:#ae81ff">echo &#34;PWD=$(Get-Location)&#34; &gt;&gt; $env:GITHUB_ENV        </span>

- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">SETUP FEATURE BRANCH</span>
  <span style="color:#f92672">if</span>: <span style="color:#ae81ff">${{ github.ref != &#39;refs/heads/main&#39; &amp;&amp; github.ref != &#39;refs/heads/master&#39; }}</span>
  <span style="color:#f92672">run</span>: |<span style="color:#e6db74">
</span><span style="color:#e6db74">    echo &#34;ENV=dev&#34; &gt;&gt; $env:GITHUB_ENV        
</span><span style="color:#e6db74">    echo &#34;TAG=${{ github.ref_name }}&#34; &gt;&gt; $env:GITHUB_ENV
</span><span style="color:#e6db74">    echo &#34;PWD=$(Get-Location)&#34; &gt;&gt; $env:GITHUB_ENV        </span>    
</code></pre></div><p>Notationally, the only difference here is <code>&gt;&gt; $GITHUB_ENV</code> and <code>&gt;&gt; $env:GITHUB_ENV</code>.  Powershell requires the pre-suffix of <code>env:</code> (as in <code>Get-ChildItem env:</code>).  The consumer syntax of this env var remains the same between shells - <code>${{ env.TAG }}</code> - so it&rsquo;s only the creation of this env var that needs to change between shells.</p>
<p>For context, I&rsquo;ve pasted below an example of where the <code>TAG</code> env var is being consumed:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml">- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">BUILD AND PUSH</span>
  <span style="color:#f92672">run</span>: |<span style="color:#e6db74">
</span><span style="color:#e6db74">    try {
</span><span style="color:#e6db74">        cd ${{ env.ROOT_DIR }}   
</span><span style="color:#e6db74">        docker build -t ${{ env.ACR_NAME }}/${{ env.APP_DOCKERIMAGE }}:${{ env.TAG }} -f ${{ env.ROOT_DIR }}/${{ env.APP_DOCKERFILE }} .
</span><span style="color:#e6db74">        docker push ${{ env.ACR_NAME }}/${{ env.APP_DOCKERIMAGE }}:${{ env.TAG }}
</span><span style="color:#e6db74">    } catch {
</span><span style="color:#e6db74">        Write-Output &#34;Could not push to ACR, error occured with docker build&#34;
</span><span style="color:#e6db74">        Exit 1
</span><span style="color:#e6db74">    }        </span>    
</code></pre></div><h1 id="cicd">CICD</h1>
<p>Here&rsquo;s a note on being sympathetic to our development teams' nuances&hellip;</p>
<blockquote class="book-hint info">
  We are using the approach of regenerating feature images and deploying from one workflow_dispatcher instead of triggering a deployment from a merge to a dedicated development branch. Our (the virtual team I&rsquo;m managing that is the Platform Team - senior staff) combined experience lead us to determine that a dedicated development branch will get out of sync with our main branch.  This is especially problematic if your branching strategy predicates promoting to production via a merge to main from a dedicated development branch.  To compound this point, we often have multiple developers concurrently working on the same repo so this in itself presents inherent complexities so arriving at a CICD pipelines wasn&rsquo;t clear cut as teams have subtle nuances around how they build &amp; deploy features/fixes.
</blockquote>

</p>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex justify-between">





</div>

 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#github-workflows">Github workflows</a></li>
    <li><a href="#cicd">CICD</a></li>
  </ul>
</nav>

 
    </aside>
    
  </main>

  
</body>

</html>












